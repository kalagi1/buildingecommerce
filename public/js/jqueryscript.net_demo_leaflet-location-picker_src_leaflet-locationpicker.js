
(function (factory) {
    if(typeof define === 'function' && define.amd) {
    //AMD
        define(['jquery','leaflet'], factory);
    } else if(typeof module !== 'undefined') {
    // Node/CommonJS
        module.exports = factory(require('jquery','leaflet'));
    } else {
    // Browser globals
    	if(typeof window.jQuery === 'undefined')
            throw 'jQuery must be loaded first';
        if(typeof window.L === 'undefined')
            throw 'Leaflet must be loaded first';
        factory(window.jQuery, window.L);
    }
})(function(jQuery, L){

	var $ = jQuery;

	$.fn.leafletLocationPicker = function(opts, onChangeLocation) {

		var http = window.location.protocol;

		var baseClassName = 'leaflet-locpicker',
			baseLayers = {
				'OSM': http + '//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',
				'SAT': http + '//otile1.mqcdn.com/tiles/1.0.0/sat/{z}/{x}/{y}.png'
				//TODO add more free base layers
			};

		var optsMap = {
				zoom: 5,
				center: L.latLng([40,0]),
				zoomControl: false,
				attributionControl: true
			};

		if($.isPlainObject(opts) && $.isPlainObject(opts.map))
			optsMap = $.extend(optsMap, opts.map);

		var defaults = {
      		alwaysOpen: false,
			className: baseClassName,
			location: optsMap.center,
			locationFormat: '{lat}{sep}{lng}',
			locationMarker: true,
			locationDigits: 6,
			locationSep: ',',
			position: 'topright',
			layer: 'OSM',
			height: 140,
			width: 200,
			event: 'click',
			cursorSize: '30px',
			map: optsMap,
			onChangeLocation: $.noop,
      		mapContainer: ""
		};

		if($.isPlainObject(opts))
			opts = $.extend(defaults, opts);

		else if($.isFunction(opts))
			opts = $.extend(defaults, {
				onChangeLocation: opts
			});
		else
			opts = defaults;

		if($.isFunction(onChangeLocation))
			opts = $.extend(defaults, {
				onChangeLocation: onChangeLocation
			});

		function roundLocation(loc) {
			return loc ? L.latLng(
				parseFloat(loc.lat).toFixed(opts.locationDigits),
				parseFloat(loc.lng).toFixed(opts.locationDigits)
			) : loc;
		}

		function parseLocation(loc) {
			var retLoc = loc;

			switch($.type(loc)) {
				case 'string':
					var ll = loc.split(opts.locationSep);
					if(ll[0] && ll[1])
						retLoc = L.latLng(ll);
					else
						retLoc = null;
				break;
				case 'array':
					retLoc = L.latLng(loc);
				break;
				case 'object':
					var lat, lng;
					if(loc.hasOwnProperty('lat'))
						lat = loc.lat;
					else if(loc.hasOwnProperty('latitude'))
						lat = loc.latitude;

					if(loc.hasOwnProperty('lng'))
						lng = loc.lng;
					else if(loc.hasOwnProperty('lon'))
						lng = loc.lon;
					else if(loc.hasOwnProperty('longitude'))
						lng = loc.longitude;

					retLoc = L.latLng(parseFloat(lat),parseFloat(lng));
				break;
				default:
					retLoc = loc;
			}
			return roundLocation( retLoc );
		}

		function buildMap(self) {

			self.divMap = document.createElement('div');
			self.$map = $(document.createElement('div'))
				.addClass(opts.className + '-map')
				.height(opts.height)
				.width(opts.width)
				.append(self.divMap);
      //adds either as global div or specified container
      //if added to specified container add some style class
      if(opts.mapContainer && $(opts.mapContainer))
        self.$map.appendTo(opts.mapContainer)
        .addClass('map-select');
      else
        self.$map.appendTo('body');

			if(self.location)
				opts.map.center = self.location;

			if(typeof opts.layer === 'string' && baseLayers[opts.layer])
				opts.map.layers = L.tileLayer(baseLayers[opts.layer]);

			else if(opts.layer instanceof L.TileLayer ||
					opts.layer instanceof L.LayerGroup )
				opts.map.layers = opts.layer;

			else
				opts.map.layers = L.tileLayer(baseLayers.OSM);

			//leaflet map
			self.map = L.map(self.divMap, opts.map)
				.addControl( L.control.zoom({position:'bottomright'}) )
				.on(opts.event, function(e) {
					self.setLocation(e.latlng);
				});
			

				var polygon = L.polygon([
					[ 37.2608133, 38.4986444 ], [ 37.2627813, 38.4878625 ], [ 37.2690131, 38.4742546 ], [ 37.2796336, 38.4723713 ], [ 37.290191, 38.4680508 ], [ 37.2930538, 38.4554122 ], [ 37.3014839, 38.4478016 ], [ 37.3943047, 38.4236515 ], [ 37.4061122, 38.4197971 ], [ 37.409379, 38.4172684 ], [ 37.411898, 38.4124987 ], [ 37.4194548, 38.4100315 ], [ 37.4475831, 38.4046033 ], [ 37.4692041, 38.3960489 ], [ 37.4796997, 38.3878227 ], [ 37.4855773, 38.3861773 ], [ 37.4941837, 38.3776208 ], [ 37.5229417, 38.3608339 ], [ 37.5359563, 38.352439 ], [ 37.5449826, 38.3507928 ], [ 37.5630351, 38.3507928 ], [ 37.5687027, 38.3470065 ], [ 37.5948733, 38.3349788 ], [ 37.6033383, 38.3224728 ], [ 37.6121546, 38.318685 ], [ 37.6243296, 38.3178615 ], [ 37.6440613, 38.3091322 ], [ 37.6511984, 38.3043554 ], [ 37.6556065, 38.2985898 ], [ 37.6627436, 38.284421 ], [ 37.6658923, 38.2812903 ], [ 37.666215, 38.2756304 ], [ 37.6627424, 38.2609241 ], [ 37.6713488, 38.2561441 ], [ 37.6801652, 38.2485613 ], [ 37.6804636, 38.2347062 ], [ 37.6917184, 38.2296327 ], [ 37.7026339, 38.2222122 ], [ 37.7190238, 38.2194849 ], [ 37.7319913, 38.2098039 ], [ 37.732209, 38.2038044 ], [ 37.7518928, 38.1758584 ], [ 37.7389358, 38.1525262 ], [ 37.7159768, 38.1460289 ], [ 37.7157784, 38.1384289 ], [ 37.7227754, 38.1249359 ], [ 37.7162842, 38.1170072 ], [ 37.7001933, 38.1067785 ], [ 37.6804216, 38.0932085 ], [ 37.6648406, 38.0790741 ], [ 37.6373056, 38.080084 ], [ 37.6226115, 38.0670857 ], [ 37.6354184, 38.0591635 ], [ 37.6289168, 38.0497028 ], [ 37.6211064, 38.0437216 ], [ 37.603553, 38.0395988 ], [ 37.5948681, 38.0427856 ], [ 37.5805048, 38.0377703 ], [ 37.5878048, 38.027752 ], [ 37.5796865, 38.0187003 ], [ 37.5737406, 37.9908695 ], [ 37.5929684, 37.9746661 ], [ 37.5969022, 37.9621211 ], [ 37.5938628, 37.9522427 ], [ 37.6010613, 37.9462617 ], [ 37.6120289, 37.938501 ], [ 37.6164924, 37.9452884 ], [ 37.6184079, 37.9493165 ], [ 37.6294221, 37.9508269 ], [ 37.645704, 37.9537219 ], [ 37.6595116, 37.9520856 ], [ 37.6708451, 37.9430225 ], [ 37.6773898, 37.9480577 ], [ 37.6856903, 37.957372 ], [ 37.6912772, 37.9615252 ], [ 37.6931869, 37.9587782 ], [ 37.694343, 37.9561695 ], [ 37.6938661, 37.9544234 ], [ 37.6941505, 37.9538478 ], [ 37.6947604, 37.9534832 ], [ 37.6954673, 37.9537989 ], [ 37.6961998, 37.9536377 ], [ 37.6962623, 37.9526113 ], [ 37.6952629, 37.9516094 ], [ 37.6933035, 37.9505172 ], [ 37.6934232, 37.9494535 ], [ 37.694222, 37.9486168 ], [ 37.6965916, 37.945484 ], [ 37.6982887, 37.9436159 ], [ 37.6963395, 37.9376908 ], [ 37.6928032, 37.9300369 ], [ 37.6895454, 37.9286884 ], [ 37.6898039, 37.926567 ], [ 37.6843277, 37.9217301 ], [ 37.6815798, 37.9139163 ], [ 37.6844851, 37.9107511 ], [ 37.6891659, 37.9093386 ], [ 37.7019067, 37.9126301 ], [ 37.725045, 37.9116663 ], [ 37.7339203, 37.9207207 ], [ 37.7420673, 37.9272715 ], [ 37.7563297, 37.9346271 ], [ 37.7636066, 37.9135887 ], [ 37.7582439, 37.908066 ], [ 37.7668294, 37.9018638 ], [ 37.7667569, 37.8875539 ], [ 37.7830831, 37.8893343 ], [ 37.7840792, 37.8847747 ], [ 37.8061221, 37.8851081 ], [ 37.8161054, 37.8804582 ], [ 37.8595005, 37.8804997 ], [ 37.8710757, 37.8877874 ], [ 37.884658, 37.8884296 ], [ 37.9146293, 37.8824554 ], [ 37.935352, 37.880511 ], [ 37.9497006, 37.8712079 ], [ 37.9608306, 37.8679243 ], [ 37.9661026, 37.8665777 ], [ 37.9754837, 37.8703606 ], [ 37.9924801, 37.8827878 ], [ 38.0116218, 37.8908094 ], [ 38.0385581, 37.8991055 ], [ 38.0424608, 37.9041839 ], [ 38.0443442, 37.9124252 ], [ 38.0505761, 37.9190532 ], [ 38.0656444, 37.9311635 ], [ 38.0707619, 37.936321 ], [ 38.0824185, 37.9425992 ], [ 38.097771, 37.9497736 ], [ 38.1020356, 37.9580682 ], [ 38.1068688, 37.9672584 ], [ 38.1319776, 37.9760787 ], [ 38.1361596, 37.9882346 ], [ 38.1476768, 37.9931648 ], [ 38.1508503, 37.9970183 ], [ 38.1533926, 38.0051629 ], [ 38.1472434, 38.0112513 ], [ 38.1396451, 38.0151016 ], [ 38.1337574, 38.015164 ], [ 38.1102629, 38.0475722 ], [ 38.1111334, 38.0561419 ], [ 38.1107051, 38.0654436 ], [ 38.1186012, 38.0749257 ], [ 38.1265822, 38.0791475 ], [ 38.1436581, 38.0830008 ], [ 38.1623184, 38.0786133 ], [ 38.1717972, 38.0833844 ], [ 38.1746173, 38.1037278 ], [ 38.1729692, 38.1092858 ], [ 38.1805035, 38.1190112 ], [ 38.1906694, 38.1303763 ], [ 38.2071462, 38.1368422 ], [ 38.2150104, 38.1483825 ], [ 38.2308436, 38.1552157 ], [ 38.2391656, 38.1532552 ], [ 38.2487897, 38.1538286 ], [ 38.2528753, 38.149342 ], [ 38.2600871, 38.1389999 ], [ 38.2914832, 38.1376719 ], [ 38.3124323, 38.1269988 ], [ 38.3253982, 38.120129 ], [ 38.3354804, 38.1150298 ], [ 38.340895, 38.1168287 ], [ 38.3446983, 38.1191091 ], [ 38.3552126, 38.1188825 ], [ 38.3620171, 38.1203604 ], [ 38.3737711, 38.1170829 ], [ 38.3884281, 38.1067722 ], [ 38.3940057, 38.108069 ], [ 38.3998083, 38.1112299 ], [ 38.4035279, 38.1141564 ], [ 38.4104058, 38.1109315 ], [ 38.4235713, 38.1216077 ], [ 38.4256071, 38.127351 ], [ 38.4339305, 38.134898 ], [ 38.4392315, 38.1599503 ], [ 38.4505997, 38.1902912 ], [ 38.4735396, 38.1839733 ], [ 38.4922172, 38.1817073 ], [ 38.5069964, 38.1605009 ], [ 38.5202716, 38.156223 ], [ 38.528817, 38.1559495 ], [ 38.5391475, 38.1517717 ], [ 38.547001, 38.1496745 ], [ 38.553388, 38.1475093 ], [ 38.556696, 38.1462762 ], [ 38.5727163, 38.1362855 ], [ 38.5730685, 38.1286684 ], [ 38.5758855, 38.1232668 ], [ 38.5767659, 38.116895 ], [ 38.5818718, 38.1117696 ], [ 38.5852171, 38.1058125 ], [ 38.5892667, 38.1020717 ], [ 38.5940205, 38.0934811 ], [ 38.6044085, 38.0865525 ], [ 38.6091623, 38.0801775 ], [ 38.6202546, 38.0733862 ], [ 38.6304665, 38.0728318 ], [ 38.6366289, 38.0690894 ], [ 38.6497069, 38.0651564 ], [ 38.6602128, 38.058741 ], [ 38.6894033, 38.0565012 ], [ 38.7185433, 38.0441675 ], [ 38.7410218, 38.0388524 ], [ 38.7499921, 38.0304618 ], [ 38.7537645, 38.0195663 ], [ 38.7588015, 38.0153821 ], [ 38.7654164, 38.004803 ], [ 38.7713207, 38.0033576 ], [ 38.7920617, 37.9988692 ], [ 38.8078736, 38.0029306 ], [ 38.8248716, 38.0210865 ], [ 38.8343184, 38.0338206 ], [ 38.8498141, 38.0522008 ], [ 38.8673957, 38.0845478 ], [ 38.8776411, 38.093281 ], [ 38.9333266, 38.0947435 ], [ 38.9984771, 38.0924461 ], [ 39.0161622, 38.093309 ], [ 39.0281375, 38.0935887 ], [ 39.0394937, 38.0949806 ], [ 39.0488401, 38.1006371 ], [ 39.050221, 38.1142899 ], [ 39.0508148, 38.130157 ], [ 39.0589033, 38.1386129 ], [ 39.0725971, 38.1470897 ], [ 39.0830653, 38.156635 ], [ 39.0989484, 38.1662208 ], [ 39.1097736, 38.1692085 ], [ 39.1219902, 38.1735544 ], [ 39.1326539, 38.1781281 ], [ 39.1291211, 38.1867877 ], [ 39.126504, 38.1866985 ], [ 39.1219983, 38.18831 ], [ 39.1157448, 38.1923193 ], [ 39.1117475, 38.1955929 ], [ 39.1076485, 38.2006914 ], [ 39.10654, 38.2038182 ], [ 39.110813, 38.2084594 ], [ 39.119683, 38.210644 ], [ 39.1286328, 38.2186527 ], [ 39.1311912, 38.2222205 ], [ 39.1326961, 38.2242238 ], [ 39.1345093, 38.2253854 ], [ 39.1388564, 38.2310565 ], [ 39.1413765, 38.25572 ], [ 39.1463547, 38.2743197 ], [ 39.1511612, 38.2914326 ], [ 39.1514252, 38.2992522 ], [ 39.1433633, 38.3118548 ], [ 39.119012, 38.3303146 ], [ 39.1131485, 38.3440357 ], [ 39.1062794, 38.3478962 ], [ 39.0997085, 38.3414976 ], [ 39.0862602, 38.3413963 ], [ 39.0745337, 38.3433421 ], [ 39.0591654, 38.3364926 ], [ 39.0482239, 38.338132 ], [ 39.0380475, 38.3337156 ], [ 39.0333326, 38.3334485 ], [ 39.0294415, 38.3320606 ], [ 39.0166128, 38.3333443 ], [ 39.0061845, 38.3324172 ], [ 38.9994355, 38.3259485 ], [ 38.9890407, 38.3193777 ], [ 38.9797136, 38.3192805 ], [ 38.9697186, 38.3189906 ], [ 38.9677752, 38.3188946 ], [ 38.9585749, 38.3239365 ], [ 38.9531428, 38.327428 ], [ 38.9476393, 38.3334557 ], [ 38.9338645, 38.3415268 ], [ 38.9277227, 38.3492262 ], [ 38.9176505, 38.3556887 ], [ 38.908956, 38.3569956 ], [ 38.894535, 38.3561557 ], [ 38.8902424, 38.3581649 ], [ 38.8848907, 38.3647569 ], [ 38.8820887, 38.3767707 ], [ 38.8767066, 38.3864261 ], [ 38.867576, 38.3935788 ], [ 38.8568233, 38.4000437 ], [ 38.8435721, 38.404847 ], [ 38.8344346, 38.4097645 ], [ 38.8329283, 38.4117726 ], [ 38.8318099, 38.4166295 ], [ 38.8322564, 38.4257289 ], [ 38.8337801, 38.4319105 ], [ 38.8302175, 38.435251 ], [ 38.8248893, 38.4381948 ], [ 38.81946, 38.440208 ], [ 38.813149, 38.4435089 ], [ 38.7930337, 38.4352519 ], [ 38.7569425, 38.4298308 ], [ 38.7488785, 38.4273367 ], [ 38.7358245, 38.4195547 ], [ 38.7280425, 38.4167768 ], [ 38.7141646, 38.4151137 ], [ 38.7083205, 38.4156708 ], [ 38.6733246, 38.4234458 ], [ 38.6639583, 38.4261547 ], [ 38.6502686, 38.4301138 ], [ 38.6291656, 38.4381697 ], [ 38.6147156, 38.4456619 ], [ 38.6094436, 38.4467759 ], [ 38.6047136, 38.4465018 ], [ 38.5966566, 38.4439909 ], [ 38.5919416, 38.4437239 ], [ 38.5866545, 38.4445478 ], [ 38.5797194, 38.4487139 ], [ 38.5730435, 38.4567779 ], [ 38.5661085, 38.4609359 ], [ 38.5447156, 38.4637129 ], [ 38.5324935, 38.4687179 ], [ 38.5230405, 38.4678788 ], [ 38.5111005, 38.4642699 ], [ 38.5058286, 38.4642699 ], [ 38.4847106, 38.4720519 ], [ 38.4685975, 38.474829 ], [ 38.4616546, 38.4789948 ], [ 38.4566576, 38.4839919 ], [ 38.4505535, 38.4884399 ], [ 38.4408196, 38.4956453 ], [ 38.4243044, 38.5082621 ], [ 38.4091129, 38.5167587 ], [ 38.384858, 38.5253309 ], [ 38.3760985, 38.532332 ], [ 38.3694084, 38.5362081 ], [ 38.3618553, 38.5418475 ], [ 38.3573921, 38.5517824 ], [ 38.3574905, 38.5698381 ], [ 38.3568772, 38.5960703 ], [ 38.3574905, 38.6065052 ], [ 38.3597954, 38.6187405 ], [ 38.3658035, 38.6324196 ], [ 38.3758315, 38.6464993 ], [ 38.3783185, 38.6495503 ], [ 38.3872145, 38.6562183 ], [ 38.4038845, 38.6712253 ], [ 38.4124954, 38.6842961 ], [ 38.42537, 38.6887179 ], [ 38.4440811, 38.6916656 ], [ 38.4585007, 38.6946132 ], [ 38.4672085, 38.6970594 ], [ 38.4713746, 38.7034444 ], [ 38.4749906, 38.7159415 ], [ 38.4761046, 38.7289955 ], [ 38.4732184, 38.7319838 ], [ 38.4710422, 38.7376979 ], [ 38.4670081, 38.7460661 ], [ 38.4712138, 38.7502164 ], [ 38.477737, 38.7536971 ], [ 38.4838309, 38.7541656 ], [ 38.4919355, 38.7512276 ], [ 38.5019412, 38.7463339 ], [ 38.5090507, 38.7479844 ], [ 38.5144592, 38.751417 ], [ 38.5245474, 38.7636465 ], [ 38.5332163, 38.7651188 ], [ 38.5421856, 38.7641819 ], [ 38.5581072, 38.7583258 ], [ 38.5684927, 38.753607 ], [ 38.581539, 38.7517663 ], [ 38.587118, 38.7513647 ], [ 38.5950573, 38.7520006 ], [ 38.6004646, 38.7542429 ], [ 38.603855, 38.7544102 ], [ 38.6078461, 38.7530381 ], [ 38.6248406, 38.7442356 ], [ 38.628188, 38.7448715 ], [ 38.6352363, 38.7483421 ], [ 38.6454501, 38.7564414 ], [ 38.6452785, 38.7612603 ], [ 38.6334338, 38.768555 ], [ 38.627254, 38.77431 ], [ 38.6289706, 38.7791277 ], [ 38.6351504, 38.7820048 ], [ 38.6389372, 38.7827263 ], [ 38.6469035, 38.7900137 ], [ 38.653593, 38.7960623 ], [ 38.6490909, 38.8105167 ], [ 38.6474195, 38.8202114 ], [ 38.6356934, 38.8286431 ], [ 38.6324668, 38.8347925 ], [ 38.6340414, 38.8421366 ], [ 38.6283186, 38.8517265 ], [ 38.6184206, 38.8622125 ], [ 38.6149354, 38.8707045 ], [ 38.6104025, 38.8774289 ], [ 38.6071987, 38.8847888 ], [ 38.5918338, 38.9006533 ], [ 38.5720055, 38.9117967 ], [ 38.569996, 38.9226964 ], [ 38.5785993, 38.9301773 ], [ 38.5991677, 38.9471191 ], [ 38.5998345, 38.9582521 ], [ 38.5975353, 38.9711388 ], [ 38.6143424, 38.9748746 ], [ 38.6503517, 38.9936403 ], [ 38.6546857, 39.0055524 ], [ 38.6594881, 39.0124637 ], [ 38.6611436, 39.0183773 ], [ 38.6668083, 39.0215127 ], [ 38.6824406, 39.0280148 ], [ 38.688528, 39.0311177 ], [ 38.6857776, 39.0341901 ], [ 38.6849477, 39.0367687 ], [ 38.6815243, 39.0388637 ], [ 38.6800374, 39.0408243 ], [ 38.6769944, 39.0437786 ], [ 38.6758187, 39.0478875 ], [ 38.6732253, 39.0487469 ], [ 38.672015, 39.049821 ], [ 38.6700344, 39.0507325 ], [ 38.6691542, 39.0520237 ], [ 38.6674886, 39.0531483 ], [ 38.661955, 39.0549537 ], [ 38.6593142, 39.054498 ], [ 38.6497092, 39.0588124 ], [ 38.6499964, 39.0621106 ], [ 38.6431253, 39.0672954 ], [ 38.6412203, 39.0740146 ], [ 38.6428829, 39.0752294 ], [ 38.6388062, 39.0785199 ], [ 38.6378174, 39.0777483 ], [ 38.6370361, 39.0775859 ], [ 38.6366758, 39.0782988 ], [ 38.6376099, 39.0788628 ], [ 38.6376993, 39.0798609 ], [ 38.6321084, 39.085384 ], [ 38.628396, 39.0884625 ], [ 38.6164215, 39.0973155 ], [ 38.6161821, 39.1022546 ], [ 38.613248, 39.1048351 ], [ 38.6069884, 39.1090852 ], [ 38.6015114, 39.110603 ], [ 38.5980882, 39.1130314 ], [ 38.5959365, 39.1116655 ], [ 38.5883487, 39.1128022 ], [ 38.5859799, 39.1110307 ], [ 38.5787333, 39.1114209 ], [ 38.5674723, 39.1148778 ], [ 38.5627745, 39.1133409 ], [ 38.5376046, 39.120907 ], [ 38.5235576, 39.1338085 ], [ 38.5099562, 39.1408352 ], [ 38.4996022, 39.1430157 ], [ 38.4684003, 39.1427549 ], [ 38.4199965, 39.1204919 ], [ 38.4054243, 39.1155657 ], [ 38.388764, 39.1153751 ], [ 38.3736796, 39.1186774 ], [ 38.3624192, 39.1231843 ], [ 38.3502144, 39.1356541 ], [ 38.3320768, 39.151549 ], [ 38.3242273, 39.1527896 ], [ 38.2988182, 39.1426241 ], [ 38.2517918, 39.1378325 ], [ 38.222283, 39.1229617 ], [ 38.1866958, 39.0967238 ], [ 38.1736229, 39.0877413 ], [ 38.1617377, 39.0832318 ], [ 38.1504697, 39.0829274 ], [ 38.1413263, 39.084503 ], [ 38.1102702, 39.0848074 ], [ 38.0805651, 39.0893768 ], [ 38.0609283, 39.0964367 ], [ 38.0557523, 39.0877218 ], [ 38.0372287, 39.0931634 ], [ 38.0117618, 39.0871238 ], [ 37.9998376, 39.0880138 ], [ 37.9921381, 39.0790761 ], [ 37.9801547, 39.0779902 ], [ 37.962456, 39.0828301 ], [ 37.9480053, 39.0717871 ], [ 37.9341363, 39.0683176 ], [ 37.9064918, 39.0727229 ], [ 37.8889577, 39.0739266 ], [ 37.8519382, 39.0852341 ], [ 37.8279408, 39.0897352 ], [ 37.8048265, 39.0877916 ], [ 37.7782577, 39.0819999 ], [ 37.76635, 39.0714304 ], [ 37.7593683, 39.0581829 ], [ 37.757543, 39.0403385 ], [ 37.7703318, 39.0316246 ], [ 37.7716822, 39.0216026 ], [ 37.7793275, 39.0127249 ], [ 37.7836371, 39.0097262 ], [ 37.7779743, 38.9973875 ], [ 37.7731857, 38.9914859 ], [ 37.7644346, 38.9822164 ], [ 37.7561035, 38.9747083 ], [ 37.7527695, 38.9727703 ], [ 37.7486035, 38.9716563 ], [ 37.7377776, 38.9719314 ], [ 37.7280426, 38.9741514 ], [ 37.7205505, 38.9777753 ], [ 37.6888886, 38.9874873 ], [ 37.6772156, 38.9930494 ], [ 37.6708296, 38.9972073 ], [ 37.6663816, 38.9986034 ], [ 37.6433256, 39.0094374 ], [ 37.6130468, 39.0147614 ], [ 37.6025843, 39.0108094 ], [ 37.5936211, 39.013666 ], [ 37.5850384, 39.0116835 ], [ 37.5697316, 39.0105881 ], [ 37.5579782, 39.0143307 ], [ 37.5471955, 39.01216 ], [ 37.5294869, 39.0067461 ], [ 37.5232332, 39.0159125 ], [ 37.5141008, 39.0274971 ], [ 37.5108285, 39.0348917 ], [ 37.4939728, 39.0405027 ], [ 37.4807291, 39.0414378 ], [ 37.469492, 39.0342682 ], [ 37.4703158, 39.0210862 ], [ 37.4805906, 39.005062 ], [ 37.5046595, 38.9730343 ], [ 37.5086795, 38.9632939 ], [ 37.5268299, 38.9433529 ], [ 37.5361475, 38.9339214 ], [ 37.5451215, 38.9297049 ], [ 37.5428669, 38.9168863 ], [ 37.5502438, 38.9052614 ], [ 37.5450405, 38.8842768 ], [ 37.5352127, 38.8471588 ], [ 37.5582508, 38.8034883 ], [ 37.5576972, 38.7926114 ], [ 37.5558713, 38.7888147 ], [ 37.5397993, 38.7792692 ], [ 37.5399855, 38.7633284 ], [ 37.5374906, 38.7602764 ], [ 37.5313796, 38.7558294 ], [ 37.5149916, 38.7458264 ], [ 37.5038756, 38.7358244 ], [ 37.4972076, 38.7269444 ], [ 37.4886016, 38.7194364 ], [ 37.4769436, 38.7155453 ], [ 37.4486005, 38.7124943 ], [ 37.4355545, 38.7097164 ], [ 37.4322125, 38.7077633 ], [ 37.4294355, 38.7052694 ], [ 37.4255446, 38.6986004 ], [ 37.4186095, 38.6897124 ], [ 37.4108275, 38.6816634 ], [ 37.4069134, 38.6641238 ], [ 37.4066504, 38.657236 ], [ 37.4027972, 38.6496842 ], [ 37.4043946, 38.6330947 ], [ 37.4076596, 38.6197073 ], [ 37.4025031, 38.608937 ], [ 37.3644948, 38.5929695 ], [ 37.3337325, 38.5959469 ], [ 37.3195406, 38.5970616 ], [ 37.3133362, 38.5822195 ], [ 37.3001507, 38.5655675 ], [ 37.3039123, 38.5608483 ], [ 37.3111116, 38.5500905 ], [ 37.3118687, 38.5390385 ], [ 37.2936122, 38.5232825 ], [ 37.269669, 38.5125044 ], [ 37.2634372, 38.5071147 ], [ 37.2608133, 38.4986444 ] 
					// Diğer noktalar...
				]).addTo(self.map);
			
			if(opts.activeOnMove) {
				self.map.on('move', function(e) {
					self.setLocation(e.target.getCenter());
				});
			}

			//only adds closeBtn if not alwaysOpen
			if(opts.alwaysOpen!==true){
				var xmap = L.control({position: 'topright'});
				xmap.onAdd = function(map) {
					var btn_holder = L.DomUtil.create('div', 'leaflet-bar');
					var btn = L.DomUtil.create('a','leaflet-control '+opts.className+'-close');
					btn.innerHTML = '&times;';
					btn_holder.appendChild(btn);
					L.DomEvent
						.on(btn, 'click', L.DomEvent.stop, self)
						.on(btn, 'click', self.closeMap, self);
					return btn_holder;
				};
				xmap.addTo(self.map);
			}

			if(opts.locationMarker)
				self.marker = buildMarker(self.location).addTo(self.map);

			return self.$map;
		}

		function buildMarker(loc) {
			var css = 'padding: 0px; margin: 0px; position: absolute; outline: 1px solid #fff; box-shadow: 1px 1px 3px rgba(0, 0, 0, 0.6);';

			return L.marker( parseLocation(loc) || L.latLng(0,0), {
				icon: L.divIcon({
					className: opts.className+'-marker',
					iconAnchor: L.point(0, 0),
					html: '<div style="position: relative; top: -1px; left: -1px; padding: 0px; margin: 0px; cursor: crosshair;'+
								'width: ' + opts.cursorSize + '; height: ' + opts.cursorSize + ';">'+
							'<div style="width: 50%; height: 0px; left: -70%; border-top:  2px solid black;' + css + '"></div>'+
							'<div style="width: 50%; height: 0px; left:  30%; border-top:  2px solid black;' + css + '"></div>'+
							'<div style="width: 0px; height: 50%; top:   30%; border-left: 2px solid black;' + css + '"></div>'+
							'<div style="width: 0px; height: 50%; top:  -70%; border-left: 2px solid black;' + css + '"></div>'+
						'</div>',
				})
			});
		}

		$(this).each(function(index, input) {
		    var self = this;

		    self.$input = $(this);

		    self.locationOri = self.$input.val();

			self.onChangeLocation = function() {
				var edata = {
					latlng: self.location,
					location: self.getLocation()
				};
				self.$input.trigger($.extend(edata, {
					type: 'changeLocation'
				}));
				opts.onChangeLocation.call(self, edata);
			};

		    self.setLocation = function(loc, noSet) {
				loc = loc || defaults.location;
				console.log(loc);
				self.location = parseLocation(loc);

				if(self.marker)
					self.marker.setLatLng(loc);

				if(!noSet) {
					self.$input.data('location', self.location);
					self.$input.val( self.getLocation() );
					self.onChangeLocation();
				}
		    };

		    self.getLocation = function() {
		    	return self.location ? L.Util.template(opts.locationFormat, {
		    		lat: self.location.lat,
		    		lng: self.location.lng,
		    		sep: opts.locationSep
		    	}) : self.location;
		    };

		    self.updatePosition = function() {
			    switch(opts.position) {
				    case 'bottomleft':
					    self.$map.css({
						    top: self.$input.offset().top + self.$input.height() + 6,
						    left: self.$input.offset().left
					    });
					    break;
				    case 'topright':
					    self.$map.css({
						    top: self.$input.offset().top,
						    left: self.$input.offset().left + self.$input.width() + 5
					    });
					    break;
			    }
		    };

		    self.openMap = function() {
			    self.updatePosition();
			    self.$map.show();
			    self.map.invalidateSize();
			    self.$input.trigger('show');
		    };

		    self.closeMap = function() {
			    self.$map.hide();
			    self.$input.trigger('hide');
		    };

		    self.setLocation(self.locationOri, true);

		    self.$map = buildMap(self);

		    self.$input
			    .addClass(opts.className)
			    .on('focus.'+opts.className, function(e) {
				    e.preventDefault();
				    self.openMap();
			    })
			    .on('blur.'+opts.className, function(e) {
				    e.preventDefault();
				    var p = e.relatedTarget;
				    var close = true;
				    while (p) {
					    if (p._leaflet) {
						    close = false;
						    break;
					    }
					    p = p.parentElement;
				    }
				    if(close) {
				    	setTimeout(function() {
					    	self.closeMap();
					    },100)
				    }
			    });

		    $(window).on('resize', function() {
				if (self.$map.is(':visible'))
					self.updatePosition();
		    });
        //opens map initially if alwaysOpen
        if(opts.alwaysOpen && opts.alwaysOpen===true) self.openMap();
		});

		return this;
	};

});
